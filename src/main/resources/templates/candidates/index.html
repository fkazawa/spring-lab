<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Candidate Registry</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet"/>
    <style>
        body {
            background-color: #f5f5f5;
        }

        .brand-logo {
            font-size: 1.4rem;
        }

        .card + .card {
            margin-top: 1.5rem;
        }

        .table-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pagination-wrapper {
            display: flex;
            justify-content: center;
            padding: 1rem 0;
        }
    </style>
</head>
<body>
<nav class="teal darken-1">
    <div class="nav-wrapper container">
        <a href="#" class="brand-logo">Candidate Registry</a>
        <ul class="right hide-on-med-and-down">
            <li>
                <a class="btn-flat white-text waves-effect"
                   th:href="@{/api/candidates/csv/download(name=${name},nationality=${nationality},origin=${origin})}">
                    <i class="material-icons left">file_download</i>Download CSV
                </a>
            </li>
        </ul>
    </div>
</nav>

<div class="container section">
    <div class="row">
        <div class="col s12 l8">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Search Candidates</span>
                    <form method="get" th:action="@{/candidates}">
                        <div class="row">
                            <div class="input-field col s12 m4">
                                <input id="name" name="name" type="text" th:value="${name}"/>
                                <label for="name" th:classappend="${name} ? ' active' : ''">Name</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="nationality" name="nationality" type="text" th:value="${nationality}"/>
                                <label for="nationality" th:classappend="${nationality} ? ' active' : ''">Nationality</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="origin" name="origin" type="text" th:value="${origin}"/>
                                <label for="origin" th:classappend="${origin} ? ' active' : ''">Origin</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s12">
                                <button class="btn waves-effect teal" type="submit">
                                    <i class="material-icons left">search</i>Search
                                </button>
                                <a class="btn-flat waves-effect" th:href="@{/candidates}">
                                    <i class="material-icons left">refresh</i>Clear filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-action hide-on-large-only">
                    <a class="btn-flat waves-effect teal-text text-darken-1"
                       th:href="@{/api/candidates/csv/download(name=${name},nationality=${nationality},origin=${origin})}">
                        <i class="material-icons left">file_download</i>Download CSV
                    </a>
                </div>
            </div>
        </div>
        <div class="col s12 l4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Upload CSV</span>
                    <form id="uploadForm" method="post" enctype="multipart/form-data"
                          th:action="@{/api/candidates/csv/upload}">
                        <div class="file-field input-field">
                            <div class="btn teal">
                                <span><i class="material-icons left">attach_file</i>Choose file</span>
                                <input type="file" name="file" accept=".csv,text/csv,application/vnd.ms-excel" required/>
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text" placeholder="Upload CSV file"/>
                            </div>
                        </div>
                        <button class="btn waves-effect teal" type="submit">
                            <i class="material-icons left">cloud_upload</i>Upload
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-content">
            <div class="table-title">
                <span class="card-title">Candidates</span>
                <span th:text="${candidates.totalElements} + ' records'"></span>
            </div>
            <div class="responsive-table">
                <table class="highlight">
                    <thead>
                    <tr>
                        <th><a class="teal-text text-darken-1" th:href="@{|/candidates?sort=externalRef|}">external_ref</a></th>
                        <th><a class="teal-text text-darken-1" th:href="@{|/candidates?sort=name|}">name</a></th>
                        <th><a class="teal-text text-darken-1" th:href="@{|/candidates?sort=age|}">age</a></th>
                        <th>nationality</th>
                        <th>origin</th>
                        <th>notes</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="c : ${candidates.content}">
                        <td th:text="${c.externalRef}"></td>
                        <td th:text="${c.name}"></td>
                        <td th:text="${c.age}"></td>
                        <td th:text="${c.nationality}"></td>
                        <td th:text="${c.origin}"></td>
                        <td th:text="${c.notes}"></td>
                    </tr>
                    <tr th:if="${candidates.empty}">
                        <td colspan="6" class="center-align grey-text text-darken-1">No candidates found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-action pagination-wrapper">
            <ul class="pagination">
                <li th:classappend="${candidates.first} ? ' disabled'">
                    <a th:href="@{|/candidates?page=${candidates.number-1}|}" class="waves-effect">
                        <i class="material-icons">chevron_left</i>
                    </a>
                </li>
                <li class="disabled">
                    <a href="#!">
                        <span th:text="${candidates.number + 1} + ' / ' + ${candidates.totalPages == 0 ? 1 : candidates.totalPages}"></span>
                    </a>
                </li>
                <li th:classappend="${candidates.last} ? ' disabled'">
                    <a th:href="@{|/candidates?page=${candidates.number+1}|}" class="waves-effect">
                        <i class="material-icons">chevron_right</i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const uploadForm = document.getElementById('uploadForm');
        if (!uploadForm) {
            return;
        }

        const submitButton = uploadForm.querySelector('button[type="submit"]');
        const fileInput = uploadForm.querySelector('input[type="file"]');
        const filePathInput = uploadForm.querySelector('.file-path');
        const setUploadingState = (isUploading) => {
            if (!submitButton) {
                return;
            }
            submitButton.disabled = isUploading;
            submitButton.classList.toggle('disabled', isUploading);
            submitButton.classList.toggle('teal', !isUploading);
            submitButton.innerHTML = isUploading
                ? '<i class="material-icons left">hourglass_top</i>Uploading...'
                : '<i class="material-icons left">cloud_upload</i>Upload';
        };

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!fileInput || fileInput.files.length === 0) {
                M.toast({html: 'Please choose a CSV file.', classes: 'red'});
                return;
            }

            setUploadingState(true);

            try {
                const formData = new FormData(uploadForm);
                const response = await fetch(uploadForm.action, {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                let payload = null;
                if (contentType && contentType.includes('application/json')) {
                    payload = await response.json();
                } else {
                    throw new Error('Unexpected response format from server.');
                }

                if (!response.ok) {
                    const errorMsg = payload && payload.message ? payload.message : 'Upload failed.';
                    M.toast({html: errorMsg, classes: 'red'});
                    return;
                }

                const {totalRows, successCount, failureCount, warnings, errorReport} = payload;
                let message = `Upload finished: ${successCount}/${totalRows} succeeded`;
                if (failureCount > 0) {
                    message += `, ${failureCount} failed`;
                }
                if (warnings && warnings.length > 0) {
                    message += `, ${warnings.length} warnings`;
                }
                if (errorReport && errorReport.available && errorReport.downloadUrl) {
                    message += ` <a class="yellow-text text-lighten-4" href="${errorReport.downloadUrl}">Download errors</a>`;
                }

                M.toast({html: message, displayLength: 6000, classes: failureCount > 0 ? 'orange darken-2' : 'teal'});
                uploadForm.reset();
                if (filePathInput) {
                    filePathInput.value = '';
                }
            } catch (err) {
                console.error(err);
                M.toast({html: err.message || 'Upload failed.', classes: 'red'});
            } finally {
                setUploadingState(false);
            }
        });
    });
</script>
</body>
</html>
